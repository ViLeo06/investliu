<view class="container">
  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="search-bar">
    <view class="search-input-container">
      <input class="search-input" placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§°" value="{{searchQuery}}" bindinput="onSearchInput" />
      <view class="search-icon">ğŸ”</view>
    </view>
    <view class="filter-button {{showFilters ? 'active' : ''}}" bindtap="toggleFilters">
      ç­›é€‰
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filters-panel {{showFilters ? 'show' : ''}}">
    <view class="filter-row">
      <text class="filter-label">æ¨èç­‰çº§</text>
      <view class="filter-tags">
        <view class="filter-tag {{recommendationFilter === '' ? 'active' : ''}}" data-value="" bindtap="onRecommendationFilter">å…¨éƒ¨</view>
        <view class="filter-tag {{recommendationFilter === 'strong_buy' ? 'active' : ''}}" data-value="strong_buy" bindtap="onRecommendationFilter">å¼ºçƒˆä¹°å…¥</view>
        <view class="filter-tag {{recommendationFilter === 'buy' ? 'active' : ''}}" data-value="buy" bindtap="onRecommendationFilter">ä¹°å…¥</view>
        <view class="filter-tag {{recommendationFilter === 'hold' ? 'active' : ''}}" data-value="hold" bindtap="onRecommendationFilter">æŒæœ‰</view>
      </view>
    </view>
    <view class="filter-row">
      <text class="filter-label">è¯„åˆ†èŒƒå›´</text>
      <view class="score-range">
        <slider class="score-slider" min="0" max="100" value="{{minScore}}" bindchange="onMinScoreChange" />
        <text class="score-text">{{minScore}}åˆ†ä»¥ä¸Š</text>
      </view>
    </view>
  </view>

  <!-- åˆ†æç»“æœåˆ—è¡¨ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <text>åŠ è½½åˆ†ææ•°æ®ä¸­...</text>
  </view>
  <view wx:elif="{{error}}" class="error-message">
    <text>{{errorMessage}}</text>
    <view class="retry-btn" bindtap="loadAnalysisData">é‡æ–°åŠ è½½</view>
  </view>
  <view wx:else class="analysis-list">
    <view wx:for="{{filteredAnalysisList}}" wx:key="*this" class="analysis-card" bindtap="viewDetail" data-code="{{item.basic_info.code}}">
      <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
      <view class="stock-header">
        <view class="stock-avatar" style="background: {{item.basic_info.industry === 'é“¶è¡Œ' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : item.basic_info.industry === 'é£Ÿå“é¥®æ–™' ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'}}">
          {{item.basic_info.name.substring(0, 2)}}
        </view>
        <view class="stock-info">
          <view class="stock-name">{{item.basic_info.name}}</view>
          <view class="stock-code">{{item.basic_info.code}} Â· {{item.basic_info.industry}}</view>
          <view class="stock-price">
            <text class="price">ï¿¥{{item.basic_info.current_price}}</text>
            <text class="change {{item.basic_info.change_percent >= 0 ? 'positive' : 'negative'}}">
              {{item.basic_info.change_percent >= 0 ? '+' : ''}}{{item.basic_info.change_percent}}%
            </text>
          </view>
        </view>
        <view class="recommendation-badge {{item.investment_summary.recommendation}}">
          {{item.investment_summary.recommendation === 'strong_buy' ? 'å¼ºçƒˆä¹°å…¥' : item.investment_summary.recommendation === 'buy' ? 'ä¹°å…¥' : item.investment_summary.recommendation === 'hold' ? 'æŒæœ‰' : 'è§‚æœ›'}}
        </view>
      </view>

      <!-- è€åˆ˜è¯„åˆ†å’Œå…³é”®æŒ‡æ ‡ -->
      <view class="analysis-summary">
        <view class="score-section">
          <view class="score-circle" style="background: conic-gradient({{item.laoliu_evaluation.laoliu_score >= 80 ? '#27ae60' : item.laoliu_evaluation.laoliu_score >= 60 ? '#f39c12' : '#e74c3c'}} {{item.laoliu_evaluation.laoliu_score * 3.6}}deg, #f0f0f0 0deg)">
            <text class="score-text">{{item.laoliu_evaluation.laoliu_score}}</text>
            <text class="score-label">è€åˆ˜è¯„åˆ†</text>
          </view>
          <view class="metrics-grid">
            <view class="metric-item">
              <text class="metric-label">PE</text>
              <text class="metric-value">{{item.valuation_metrics ? item.valuation_metrics.pe_ratio : 'N/A'}}</text>
            </view>
            <view class="metric-item">
              <text class="metric-label">PB</text>
              <text class="metric-value">{{item.valuation_metrics ? item.valuation_metrics.pb_ratio : 'N/A'}}</text>
            </view>
            <view class="metric-item">
              <text class="metric-label">ROE</text>
              <text class="metric-value">{{item.financial_metrics ? item.financial_metrics.roe + '%' : 'N/A'}}</text>
            </view>
            <view class="metric-item">
              <text class="metric-label">ç½®ä¿¡åº¦</text>
              <text class="metric-value">{{item.ai_insights ? item.ai_insights.confidence_level : 'é«˜'}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åˆ†æè¦ç‚¹ -->
      <view class="analysis-points">
        <view class="points-title">æ ¸å¿ƒè§‚ç‚¹</view>
        <view wx:for="{{item.laoliu_evaluation.analysis_points}}" wx:for-item="point" wx:for-index="pointIndex" wx:key="pointIndex" class="point-item">
          â€¢ {{point}}
        </view>
      </view>

      <!-- æŠ•èµ„å»ºè®® -->
      <view class="investment-advice">
        <text class="advice-text">{{item.laoliu_evaluation.investment_advice}}</text>
        <view class="position-suggestion" wx:if="{{item.investment_summary.position_suggestion}}">å»ºè®®ä»“ä½: {{item.investment_summary.position_suggestion}}</view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <view class="action-btn" bindtap="exportData">
      <text>å¯¼å‡ºæ•°æ®</text>
    </view>
    <view class="action-btn" bindtap="showRealtimeAnalysis">
      <text>å®æ—¶åˆ†æ</text>
    </view>
    <view class="action-btn primary" bindtap="refreshData">
      <text>åˆ·æ–°æ•°æ®</text>
    </view>
  </view>

  <!-- å®æ—¶è‚¡ç¥¨åˆ†æå¼¹çª— -->
  <view wx:if="{{showRealtimeSearch}}" class="realtime-modal" bindtap="hideRealtimeAnalysis">
    <view class="realtime-content" catchtap="">
      <view class="realtime-header">
        <text class="realtime-title">å®æ—¶è‚¡ç¥¨åˆ†æ</text>
        <view class="close-btn" bindtap="hideRealtimeAnalysis">âœ•</view>
      </view>
      
      <view class="realtime-body">
        <view class="search-section">
          <view class="search-input-wrapper">
            <input 
              class="realtime-search-input" 
              placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°ï¼ˆå¦‚ï¼š000001 æˆ– å¹³å®‰é“¶è¡Œï¼‰" 
              value="{{realtimeSearchQuery}}"
              bindinput="onRealtimeSearchInput"
              bindconfirm="searchAndAnalyzeStock"
            />
            <view class="search-btn" bindtap="searchAndAnalyzeStock">
              {{isAnalyzing ? 'åˆ†æä¸­...' : 'åˆ†æ'}}
            </view>
          </view>
          
          <view class="search-tips">
            <text class="tip-text">ğŸ’¡ æ”¯æŒAè‚¡6ä½ä»£ç æˆ–è‚¡ç¥¨åç§°</text>
          </view>
        </view>

        <!-- åˆ†æå†å² -->
        <view wx:if="{{analysisHistory.length > 0}}" class="history-section">
          <view class="history-header">
            <text>æœ€è¿‘åˆ†æ</text>
          </view>
          <scroll-view class="history-list" scroll-y>
            <view 
              wx:for="{{analysisHistory.slice(0, 5)}}" 
              wx:key="*this" 
              class="history-item"
              data-key="{{item.key}}"
              bindtap="viewHistoryAnalysis"
            >
              <view class="history-info">
                <view class="history-name">{{item.name}} ({{item.code}})</view>
                <view class="history-meta">
                  <text class="history-score">{{item.score}}åˆ†</text>
                  <text class="history-time">{{item.time}}</text>
                </view>
              </view>
              <view class="history-actions">
                <text 
                  class="delete-btn" 
                  data-key="{{item.key}}" 
                  data-code="{{item.code}}"
                  bindtap="deleteHistoryAnalysis"
                  catchtap=""
                >åˆ é™¤</text>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†æåŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isAnalyzing}}" class="analyzing-overlay">
    <view class="analyzing-content">
      <view class="analyzing-spinner"></view>
      <text class="analyzing-text">æ­£åœ¨åˆ†æè‚¡ç¥¨...</text>
      <text class="analyzing-tips">è·å–å®æ—¶æ•°æ®å¹¶è¿›è¡Œè€åˆ˜æŠ•èµ„ç†å¿µåˆ†æ</text>
    </view>
  </view>

  <!-- è‚¡ç¥¨è¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showDetail}}" class="detail-modal" bindtap="closeDetail">
    <view class="detail-content" catchtap="">
      <view class="detail-header">
        <text class="detail-title">{{selectedStock.basic_info.name}} è¯¦ç»†åˆ†æ</text>
        <view class="close-btn" bindtap="closeDetail">âœ•</view>
      </view>
      <scroll-view class="detail-body" scroll-y>
        <!-- å®Œæ•´çš„AIåˆ†æå†…å®¹ -->
        <view class="ai-analysis" wx:if="{{selectedStock.ai_insights && selectedStock.ai_insights.analysis_content}}">
          <text class="section-title">AIæ™ºèƒ½åˆ†æ</text>
          <text class="analysis-content">{{selectedStock.ai_insights.analysis_content}}</text>
        </view>
        <!-- è€åˆ˜åˆ†æè¦ç‚¹ -->
        <view class="laoliu-analysis" wx:if="{{selectedStock.laoliu_evaluation.analysis_points}}">
          <text class="section-title">è€åˆ˜åˆ†æè¦ç‚¹</text>
          <view wx:for="{{selectedStock.laoliu_evaluation.analysis_points}}" wx:for-item="point" wx:key="index" class="analysis-point">
            â€¢ {{point}}
          </view>
          <view wx:if="{{selectedStock.laoliu_evaluation.risk_warnings && selectedStock.laoliu_evaluation.risk_warnings.length > 0}}" class="risk-section">
            <text class="risk-title">é£é™©æç¤ºï¼š</text>
            <view wx:for="{{selectedStock.laoliu_evaluation.risk_warnings}}" wx:for-item="warning" wx:key="index" class="risk-item">
              âš ï¸ {{warning}}
            </view>
          </view>
        </view>
        <!-- è´¢åŠ¡æŒ‡æ ‡è¯¦æƒ… -->
        <view class="financial-details" wx:if="{{selectedStock.financial_metrics}}">
          <text class="section-title">è¯¦ç»†è´¢åŠ¡æŒ‡æ ‡</text>
          <view class="detail-metrics">
            <view class="detail-metric" wx:if="{{selectedStock.financial_metrics.roe}}">
              <text class="label">å‡€èµ„äº§æ”¶ç›Šç‡(ROE)</text>
              <text class="value">{{selectedStock.financial_metrics.roe}}%</text>
            </view>
            <view class="detail-metric" wx:if="{{selectedStock.financial_metrics.roa}}">
              <text class="label">èµ„äº§æ”¶ç›Šç‡(ROA)</text>
              <text class="value">{{selectedStock.financial_metrics.roa}}%</text>
            </view>
            <view class="detail-metric" wx:if="{{selectedStock.financial_metrics.debt_ratio}}">
              <text class="label">è´Ÿå€ºç‡</text>
              <text class="value">{{selectedStock.financial_metrics.debt_ratio * 100}}%</text>
            </view>
            <view class="detail-metric" wx:if="{{selectedStock.financial_metrics.revenue_growth}}">
              <text class="label">è¥æ”¶å¢é•¿</text>
              <text class="value">{{selectedStock.financial_metrics.revenue_growth}}%</text>
            </view>
          </view>
        </view>
        <!-- ç›®æ ‡ä»·æ ¼å’Œæ­¢æŸ -->
        <view class="price-targets" wx:if="{{selectedStock.investment_summary.target_price || selectedStock.investment_summary.stop_loss}}">
          <text class="section-title">ä»·æ ¼å»ºè®®</text>
          <view class="target-prices">
            <view class="price-item" wx:if="{{selectedStock.investment_summary.target_price}}">
              <text class="label">ç›®æ ‡ä»·æ ¼</text>
              <text class="value positive">ï¿¥{{selectedStock.investment_summary.target_price}}</text>
            </view>
            <view class="price-item" wx:if="{{selectedStock.investment_summary.stop_loss}}">
              <text class="label">æ­¢æŸä»·æ ¼</text>
              <text class="value negative">ï¿¥{{selectedStock.investment_summary.stop_loss}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>